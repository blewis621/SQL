WITH top 10 countries_cte (country) AS
SELECT E.country
FROM customer B
LEFT JOIN address C ON B. address_id = C. address_id
LEFT JOIN city D ON C. city_id = D. city_id
LEFT JOIN country D ON C. country_id = D. country_id
INNER JOIN payment E ON D. country_id = E. country_id
GROUP BY E.country
ORDER BY COUNT (B.customer_id) DESC
top10cities_cte (city) AS
FROM customer B
LEFT JOIN address C ON B. address_id = C. address_id
LEFT JOIN city D ON C. city_id = D. city_id
LEFT JOIN country D ON C. country_id = D. country_id
WHERE E.country IN (SELECT country FROM top10countries_cte)
GROUP BY E.country, D.city
ORDER BY COUNT (B.customer_id) DESC
LIMIT 10
top5customers_cte (customer_id, first_name, last_name, city, total) AS
SELECT A.customer_id, B.first_name, B.last_name, D.city, SUM (amount) AS total
LEFT JOIN customer B ON A customer_id = B. customer_id
LEFT JOIN address C ON B. address_id = C. address_id
LEFT JOIN city D ON C. city_id = D. city_id
WHERE D.city IN (SELECT city FROM top10cities_cte)
GROUP BY A.customer_id, B.first_name, B.last_name, D.city
ORDER BY SUM (amount) DESC
LIMIT 5)
SELECT AVG (total) AS top5average
FROM top5customers_cte

